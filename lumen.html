<script>
  const BG_KEY='ct_bg',LOGO_KEY='ct_logo';
  const conceptKeys=['ct_concept1','ct_concept2','ct_concept3'];
  const bgDiv=document.getElementById('bgImg');
  const logoImg=document.getElementById('logoImg');
  const bgPicker=document.getElementById('bgPicker');
  const logoPicker=document.getElementById('logoPicker');
  const resetBtn=document.getElementById('resetBtn');
  const conceptImgs=conceptKeys.map((_,i)=>document.getElementById(`concept${i+1}`));
  const conceptPickers=conceptKeys.map((_,i)=>document.getElementById(`concept${i+1}Picker`));

  // Load saved assets
  const savedBg=localStorage.getItem(BG_KEY);
  const savedLogo=localStorage.getItem(LOGO_KEY);
  if(savedBg) bgDiv.style.backgroundImage=`url(${savedBg})`;
  if(savedLogo) logoImg.src=savedLogo;

  conceptKeys.forEach((k,i)=>{
    const saved=localStorage.getItem(k);
    if(saved) conceptImgs[i].src=saved;
  });

  // Only change background when clicking empty space
  document.body.addEventListener('click',e=>{
    const ui=e.target.closest('header,nav,img,.cta,.hint,footer,a');
    if(!ui) bgPicker.click();
  });

  bgPicker.addEventListener('change',e=>{
    const f=e.target.files[0];
    if(!f)return;
    const r=new FileReader();
    r.onload=()=>{bgDiv.style.backgroundImage=`url(${r.result})`;try{localStorage.setItem(BG_KEY,r.result);}catch{}};
    r.readAsDataURL(f);
  });

  logoImg.addEventListener('click',e=>{
    e.stopPropagation(); // prevent triggering background picker
    logoPicker.click();
  });

  logoPicker.addEventListener('change',e=>{
    const f=e.target.files[0];
    if(!f)return;
    const r=new FileReader();
    r.onload=()=>{logoImg.src=r.result;try{localStorage.setItem(LOGO_KEY,r.result);}catch{}};
    r.readAsDataURL(f);
  });

  // Handle concept images properly (stop background trigger)
  conceptImgs.forEach((img,i)=>{
    img.addEventListener('click',e=>{
      e.stopPropagation(); // prevent background click
      conceptPickers[i].click();
    });
    conceptPickers[i].addEventListener('change',e=>{
      const f=e.target.files[0];
      if(!f)return;
      const r=new FileReader();
      r.onload=()=>{
        img.src=r.result;
        try{localStorage.setItem(conceptKeys[i],r.result);}catch{}
      };
      r.readAsDataURL(f);
    });
  });

  resetBtn.addEventListener('click',e=>{
    e.preventDefault();
    localStorage.removeItem(BG_KEY);
    localStorage.removeItem(LOGO_KEY);
    conceptKeys.forEach(k=>localStorage.removeItem(k));
    bgDiv.style.backgroundImage="url('https://cdn.openai.com/tmp/file_000000008ec061fdb799ce79ae92ccdb.png')";
    logoImg.src="https://i.ibb.co/gTx5qzm/ciphertech-logo.png";
    conceptImgs[0].src="https://cdn.openai.com/tmp/lumen_render_1.png";
    conceptImgs[1].src="https://cdn.openai.com/tmp/lumen_render_2.png";
    conceptImgs[2].src="https://cdn.openai.com/tmp/lumen_render_3.png";
  });

  document.getElementById('year').textContent=new Date().getFullYear();
</script>
